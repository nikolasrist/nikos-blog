<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="x-ua-compatible" content="ie=edge">
		<link rel="alternate" type="application/rss+xml" href="/rss.xml">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="description" content="Welcome to my Blog. Here I write about dev topics.">
		<title>One way to speed up CI checks in your nx monorepo</title>
		<link rel="stylesheet" href="/css/style.css"/>
		
		<script type="text/javascript">
			navigator
				.serviceWorker
				.getRegistrations()
				.then((registrations) => {
					if (!registrations && registrations.length === 0) {
						return;
					}
					for (let registration of registrations) {
						registration.unregister()
					}
				})
		</script>
	</head>
	<body class="no-grid">
		
	<a href="/" class="link-button post-home-link">All Posts</a>

		<main class="content">
			
    <article class="post-detail">

        <header class="page-header length-optimal">
            <h1 class="post-title">One way to speed up CI checks in your nx monorepo</h1>
        </header>

        <p>I originally published this blog post with my colleague Patrick Surrey on the <a target="_blank" rel="noreferrer" href="https://engineering.leanix.net/blog/smarter-nx-affected-checks/">LeanIX Engineering Blog</a>.</p>
<p>Each frontend in our nx monorepo has its own workflow for running CI checks and deployment. The default <code>nx affected</code> behaviour does not enable us to only get the list of projects that are affected and used by a specific application.</p>
<p>So we wrote a GitHub Action that does just this: <a href="https://github.com/leanix/nx-affected-depenencies-action">leanix/nx-affected-dependencies-action</a>.</p>
<p><a href="https://github.com/leanix/nx-affected-depenencies-action">Go to the action repository</a></p>
<p><a href="https://github.com/marketplace/actions/nx-affected-depencencies-action">Go to the action on the GitHub Marketplace</a></p>
<p>Our main motivation for this action was to speed up the releases of our frontend applications and to save time and money on continuous integration checks.</p>
<p><strong>The solution:</strong> By combining the <a href="https://nx.dev/l/a/cli/affected">nx affected</a> and <a href="https://nx.dev/l/a/cli/dep-graph">nx dep-graph --focus=theNameOfTheAppToDeploy</a> commands we can create an intersection of these two lists to only get the affected projects that are actually a dependency of <code>theNameOfTheAppToDeploy</code>.</p>
<p><img src="nx-affected-comparison.png" alt="Different lists of projects produced by three individual nx commands"></p>
<h2 id="how-to-use-it" tabindex="-1"><a class="header-anchor" href="#how-to-use-it">How to use it</a></h2>
<p>This is just one way to use the <code>leanix/nx-affected-dependencies-action</code> in your workflows. It resembles the use case of merging a feature branch into your <code>main</code> branch and comparing the changes of the latest commit on <code>main</code> (<code class="language-text" style="white-space: nowrap;">${{ github.sha }}~1</code>) with the merge commit of your feature branch <code class="language-text" style="white-space: nowrap;">(${{ github.sha }}</code>). <br/>For a more detailed overview, including a <code>gitflow</code> parameter, please see the project <a href="https://github.com/leanix/nx-affected-depenencies-action/blob/main/README.md">README</a>.</p>
<pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Evaluate affected<br>  <span class="token key atrule">uses</span><span class="token punctuation">:</span> leanix/nx<span class="token punctuation">-</span>affected<span class="token punctuation">-</span>dependencies<span class="token punctuation">-</span>action@v0.2.1<br>  <span class="token key atrule">id</span><span class="token punctuation">:</span> affected<br>  <span class="token key atrule">with</span><span class="token punctuation">:</span><br>    <span class="token key atrule">project</span><span class="token punctuation">:</span> pathfinder<br>    <span class="token key atrule">base</span><span class="token punctuation">:</span> $~1<br>    <span class="token key atrule">head</span><span class="token punctuation">:</span> $<br><br><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Run Unit Tests (Affected)<br>  <span class="token key atrule">if</span><span class="token punctuation">:</span> steps.affected.outputs.isAffected == 'true'<br>  <span class="token key atrule">env</span><span class="token punctuation">:</span><br>    <span class="token key atrule">affectedDeps</span><span class="token punctuation">:</span> $<br>  <span class="token key atrule">run</span><span class="token punctuation">:</span> npx nx run<span class="token punctuation">-</span>many <span class="token punctuation">-</span><span class="token punctuation">-</span>target=test <span class="token punctuation">-</span><span class="token punctuation">-</span>projects=$affectedDeps <span class="token punctuation">-</span><span class="token punctuation">-</span>runner ci</code></pre>
<p>The <a href="https://nx.dev/l/a/cli/run-many">nx run-many</a> command will run the given <code>target</code> task on the provided <code>projects</code>, which in this case come from the <code>affectedDeps</code> output of the <code>leanix/nx-affected-dependencies-action</code>.</p>
<h2 id="background" tabindex="-1"><a class="header-anchor" href="#background">Background</a></h2>
<p>As of the time of writing we are shipping 13 individual angular applications in our nx monorepo. Our CI tool of choice is GitHub Actions.<br>
All our microfrontends will be deployed after a feature branch is merged and CI checks are green.</p>
<p>The most time consuming application in our monorepo is our &quot;shell application&quot;. Among &quot;normal shell application things&quot; like the navigation bar it has the largest chunk of code of any application, since it was there long before we started adopting microfrontends.</p>
<h3 id="how-we-used-to-do-it" tabindex="-1"><a class="header-anchor" href="#how-we-used-to-do-it">How we used to do it</a></h3>
<p>This is a simplified version of the <code>Test</code> step in the workflow of a microfrontend when a feature branch is merged:</p>
<pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Test<br>  <span class="token key atrule">run</span><span class="token punctuation">:</span> npx nx affected<span class="token punctuation">:</span>test <span class="token punctuation">-</span><span class="token punctuation">-</span>base=$~1 <span class="token punctuation">-</span><span class="token punctuation">-</span>head=$ <span class="token punctuation">-</span><span class="token punctuation">-</span>runner ci</code></pre>
<p>As you can see we used the <a href="https://nx.dev/l/a/cli/affected">nx affected</a> command to lint and test the projects affected by the merged changes before deploying the new version of a frontend. However this resulted in each frontend application workflow unnecessarily linting and testing projects that are not used by them, but other applications.</p>
<p>Take a change in our shared component library for example: almost all of our applications will be affected by this. Now our small <code>todos</code> microfrontend will redundantly lint and test the large &quot;shell application&quot; and code of other microfrontends, as these are also inside the list of projects returned by <code>nx affected</code>.</p>
<p>Our nx cache does save us a significant amount of time spent on GitHub Actions, but the <code>nx affected</code> situation definitely wasn't desirable.</p>
<h2 id="results" tabindex="-1"><a class="header-anchor" href="#results">Results</a></h2>
<p>Here is a comparison of the amount of projects to check and their duration for our microfrontends when our shared component library was changed.</p>
<p><strong>Todos microfrontend:</strong><br>
<code>nx affected</code>: 62 projects in ~12 minutes<br>
<code>nx-affected-dependencies-action</code>: 13 projects in ~3 minutes</p>
<p><strong>Indicators microfrontend:</strong><br>
<code>nx affected</code>: 62 projects in ~12 minutes<br>
<code>nx-affected-dependencies-action</code>: 6 projects in ~1 minute</p>
<p>This means the <code>Todos</code> release is now completed <strong>9 minutes faster</strong> and <code>Indicators</code> <strong>11 minutes faster</strong> than before.</p>


        <em class="post-publish-date">Published 06 Dec 2021</em>

    </article>

    
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "headline": "One way to speed up CI checks in your nx monorepo",
        "author": {
            "@type": "Person",
            "name": "Nikolas Rist"
        },
        "datePublished": "2021-12-06",
        "dateModified": "2021-12-06"
    }
    </script>


		</main>
	</body>
</html>